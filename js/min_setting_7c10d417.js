F.module("superman:setting/setting_constructor",function(n,l,r){n("setting.css");var q=s_domain.staticUrl+"static/superman/img/mod/";var o=[];if(s_session.strategy_hit==2){o.push({otherClassName:"content-mod",childrenClass:"choice-border",tip:"mouseScrollGuide",domId:"mouseScroll_mod",descriptions:"滚轮切换卡片"})}else{if(s_session.strategy_hit==3){o.push({otherClassName:"content-mod",childrenClass:"choice-border",tip:"conRecommendTip",domId:"conRecommend_mod",descriptions:"情景推荐"})}}var s=$("#s_content_99"),v=true;var u={skele:['<div class="s-setting-tab s-opacity-white-background s-opacity-border1-bottom">','<span class="title">卡片管理</span>','<a href="#" onclick="return false;" class="hide-mods" id="s_hide_allmods" hidefocus><span class="bg"></span><span>隐藏全部卡片</span></a>',"#{childrenElement}","</div>",'<div class="s-setting-mods" id="s_setting_mods">','<div id="s_added_mods" class="s-opacity-white-background s-added-mods#{addModsState}">#{addedMods}</div>','<div id="s_noadd_mods" class="s-opacity-white-background s-opacity-border3-top s-noadded-mods#{noModsState}">#{noAddedMods}</div>',"</div>"].join(""),mod:['<a class="s-mod-item" id="s_moditem_#{id}" href="#" data-id="#{id}" data-imgname="#{imgname}" data-added="#{state}" data-name="#{name}" onclick="return false;" title=#{title} hidefocus>','<div class="mod-icon"><img id="s_modimg_#{id}" class="icon-img" src="#{imgUrl}" width="60px" height="60px"/></div>','<div class="mod-title"><span class="mod-check"></span><span class="title">#{name}</span><span class="subscribe">#{subscribe}</span></div>',"</a>"].join(""),confrim:['<div class="s-setting-confirm" id="s_setting_confrim">','<div class="s-confirm-win"><p class="tip">您确定取消全部订阅？</p>','<p><a class="set-btn btn-ok" href="#" onclick="return false;" hidefocus>确认</a>','<a class="set-btn btn-cancel" href="#" onclick="return false;" hidefocus>取消</a>',"</p>","</div>","</div>"].join(""),cardCtr:['<a href="#" onclick="return false;" class="hide-mods #{otherClassName}"  hidefocus>'+($.browser.ie==8?'<span class="add-forie8" style="width:84px;height:42px;position:absolute;left:0;background:#fff;filter:alpha(opacity=0);"></span>':"")+'<span class="#{borderClass} #{reviewCheck}" id="#{myId}" data-attr="#{tips}"></span><span>#{description}</span></a>']};l.render=function(){var i=$.parseJSON($.trim($("#s_menus_textarea").html())).data;i=t(i);var d=[],c=[];$.each(i,function(k,j){j.title=j.state=="1"?"取消":"选择";j.subscribe=j.state=="1"?"取消订阅":"订阅";j.imgUrl=$.url.escapeSSL("http://"+((j.id)%8+1)+".su.bdimg.com/cardicon/")+j.imgname+(j.state=="0"?"_b":"")+".png";var x=$.formatString(u.mod,j);if(j.state=="1"){d.push(x)}else{c.push(x)}});var g=d.length,a=c.length;var b=function(j){if(s_session.userTips[j]===true){return true}return false};var e="";for(var h=0;h<o.length;h++){e+=$.formatString(u.cardCtr,{otherClassName:o[h].otherClassName,borderClass:o[h].childrenClass,tips:o[h].tip,myId:o[h].domId,description:o[h].descriptions,reviewCheck:b(o[h].tip)?"checked":""})}var f={addModsState:g==0?" no-mods":(a==0?" all-mods":""),noModsState:a==0?" no-mods":(g==0?" all-mods":""),addedMods:d.join(""),noAddedMods:c.join(""),childrenElement:s_session.strategy_hit==2||s_session.strategy_hit==3?e:""};s.html($.formatString(u.skele,f))};l.updateModsLayer=function(d){var e=d=="add"?"#s_added_mods":"#s_noadd_mods",a=d=="add"?"#s_noadd_mods":"#s_added_mods",c=$(a),b=$(e);b.removeClass("no-mods");c.removeClass("all-mods");if($.isIE6&&(c.find(".s-mod-item").length==1||b.find(".s-mod-item").length==0)){b.width(b.width()+1);c.width(c.width()+1);setTimeout(function(){b.width(b.width()-1);c.width(c.width()-1)},10)}var f=c.find(".s-mod-item").length;if(f==1){c.addClass("no-mods");b.addClass("all-mods")}else{c.removeClass("no-mods");b.removeClass("all-mods")}};l.moveModItem=function(c,d){var e=d=="add"?"#s_added_mods":"#s_noadd_mods",b=$(e);c.data("added",d=="add"?"1":"0");c.find(".subscribe").html(d=="add"?"取消订阅":"订阅");c.attr("title",d=="add"?"取消":"选择");var a=$.url.escapeSSL("http://"+((c.data("id"))%8+1)+".su.bdimg.com/cardicon/")+c.data("imgname")+(d=="add"?"":"_b")+".png";c.find(".icon-img").attr("src",a);b.append(c);c.removeClass("is-hover");c.find(".mod-title").removeClass("hover-title")};var t=function(c){var a=[];for(var d=0,b=c.length;d<b;d++){if(c[d].ismenu!="1"){continue}if(p(c[d].id)){c[d].state="1"}else{c[d].state="0"}a.push(c[d])}return a};var p=function(c){var e=$("#s_ctner_menus").find(".s-menu"),d;for(var a=0,b=e.length;a<b;a++){if(c==$(e[a]).attr("data-id")){d=$(e[a]);break}}return d};l.showConfirmPop=function(c,b){var a=$("#s_setting_confrim");if(a[0]){a.show()}else{$("#s_setting_mods").append(u.confrim);a=$("#s_setting_confrim");a.delegate(".btn-ok","click",function(){r.fire("modConfirmOperate",{cmd:"ok",id:c,name:b});m()}).delegate(".btn-cancel","click",function(d){m();r.fire("modConfirmOperate",{cmd:"cancel",opSource:"pop"})})}if($.isIE6){$("#s_setting_confrim").height($("#s_setting_mods").height())}r.fire("modConfirmOperate",{cmd:"show"})};var m=function(){$("#s_setting_confrim").hide()};s.delegate(".s-setting-tab .content-mod","click",function(){var d=$(this),c=d.children("span.choice-border");value=true;var a=function(e){if(s_session.userTips[e]===true){return true}return false};var b=a(c.attr("data-attr"));if(b){value=false;c.removeClass("checked")}else{c.addClass("checked")}if(s_session.userTips.conRecommendGuide){F.use("superman:common/user_attr",function(e){e.setAttr("conRecommendGuide",false)})}F.use("superman:common/user_attr",function(e){e.setAttr(c.attr("data-attr"),value)})});l.iconImgUrl=q});F.module("superman:start/setting_start",function(h,i,j){var l=h("setting/setting_constructor"),k=h("setting/setting_action");var g=false;i.init=function(a){if(!$("#s_content_99")[0]){$("#s_ctner_contents").append('<div id="s_content_99" class="s-content" style="display:none"></div>')}if(!g){l.render();k.init();if(a=="init"){$("#s_content_99").show()}g=true}else{if($("#s_content_99").css("display")=="none"){}}}});F.module("superman:setting/mod_drag",function(o,n,s){var v="s_setting_dash_mod",t="s-setting-dash-mod",u="s_setting_drag_mod",q=8,m=false;n.init=function(){if(m){return}m=true;$("#s_added_mods").delegate(".mod-icon","mousedown",function(e){if(e.which==3){return}var f=$(this).parents(".s-mod-item"),i=f.data("id");if(!i){return}$("#s_added_mods").data("move","1");var d=l(f),a=f.offset(),j=$("#s_added_mods").offset(),b=true,k=r(f),g=e.pageX-a.left,h=e.pageY-a.top,c=false;f.hide();d.css({position:"absolute",top:a.top-j.top,left:a.left-j.left,zIndex:10});e.stopPropagation();$(document).bind("mousemove",function(aa){if(!i){return}if(!b){return}if($.isIE){d.get(0).setCapture()}else{window.captureEvents&&window.captureEvents(Event.mousemove)}var Z=p(),V={x:aa.pageX,y:aa.pageY},T=$("#s_added_mods").find("."+t).index();var M=V.x-g,N=V.y-h,R=$("#s_added_mods"),O=R.offset();if(M>O.left&&M<(O.left+R.innerWidth()-d.innerWidth())){d.css("left",M-j.left)}if(N>O.top&&N<(O.top+R.innerHeight()-d.innerHeight())){d.css("top",N-j.top)}var Q=document.body.scrollTop||document.documentElement.scrollTop;var X=Q+30,U=Q+document.documentElement.clientHeight-50;if(O.top<X){if(V.y<X){window.scrollBy(0,-20)}else{if(O.top+R.height()>U&&V.y>U){window.scrollBy(0,20)}}}else{if(O.top+R.height()>U){if(V.y>U){window.scrollBy(0,20)}}}for(var Y=0,W=Z.length;Y<W;Y++){if(d.attr("id")==Z[Y].dragId){continue}if(V.x>Z[Y].left&&V.x<Z[Y].left+Z[Y].width&&V.y>Z[Y].top&&V.y<Z[Y].top+Z[Y].height){var S=$("#"+Z[Y].dragId);if(!S[0]){return}var P=$("#s_added_mods").find(S).index();if(Z[Y].dragId.indexOf("s_moditem_")>=0){if(T>P){S.before(k)}else{S.after(k)}}else{$("#"+Z[Y].dragId).append(k)}$("#s_added_mods").toggleClass("s-xxx-ie6");c=true}}aa.preventDefault();aa.stopPropagation()});$(document).bind("mouseup",function(z){if(!i){return}$("#s_added_mods").data("move","0");if(b){if($.isIE){d.get(0).releaseCapture()}else{window.releaseEvents&&window.releaseEvents(Event.mousemove)}b=false;var y=k.offset();d.animate({top:y.top-j.top,left:y.left-j.left},{duration:100,complete:function(){k.after(f).remove();d.remove();f.show();if(c){s.use("setting/setting_action",function(w){w.saveSeqNavs(i)})}}})}})})};var r=function(b){var a=document.createElement("a");a.id=v;a.className=t;$(a).html('<div class="dash-inner"></div>');if(!$("#"+v)[0]){b.after(a)}return $(a)};var l=function(a){var b=document.createElement("div");b.id=u;b.className=a.attr("class");b.innerHTML=a.html();if(!$("#"+u)[0]){$("#s_added_mods").append(b)}if(!$.isIE6){$(b).append("<div class='drag-shadow'></div>")}$(b).addClass("drag-mod");$(b).off("mouseout").off("mouseout");return $(b)};var p=function(){var f=new Array(),a=null,i=null;var e=$("#s_added_mods").find(".s-mod-item");$.each(e,function(x,k){$mod=$(k);i=$mod.offset();f.push({dragId:$mod.attr("id"),left:i.left,top:i.top,width:$mod.width(),height:$mod.innerHeight()})});var d=$("#s_added_mods"),h=d.find(".s-mod-item");count=h.length;$.each(h,function(x,k){if($(k).css("style")=="none"){count--}});var g=Math.ceil(count/q),c=(count%q==0)?q:(q-count%q);if(c>0){var b=d.offset();var j={dragId:d.attr("id"),left:b.left+96*(q-c),top:b.top+114*(c==q?g:g-1)+q,width:96*c+36,height:114};f.push(j)}return f}});F.module("superman:setting/setting_action",function(p,x,s){var w=true;var v=p("setting/setting_constructor");var t={submit:s_domain.baseuri+"/xman/submit/supermod"};x.init=function(){o()};var o=function(){$("#s_hide_allmods").bind("click",function(){s.fire("modConfirmOperate",{cmd:"ok",opSource:"btn"})});$("#s_added_mods").delegate(".mod-title","mouseover",function(){if($("#s_added_mods").data("move")=="1"){return}$(this).addClass("hover-title")}).delegate(".mod-title","mouseout",function(){if($("#s_added_mods").data("move")=="1"){return}$(this).removeClass("hover-title")}).delegate(".mod-icon","mouseover",function(){$(this).parents(".s-mod-item").addClass("is-hover");F.call("superman:setting/mod_drag","init")}).delegate(".mod-icon","mouseout",function(){$(this).parents(".s-mod-item").removeClass("is-hover")}).delegate(".subscribe","click",function(){if(!w){return}var b=$(this),c=b.parents(".s-mod-item"),d=c.data("id");if($("#s_added_mods").find(".s-mod-item").length==1){v.showConfirmPop(d,c.data("name"));return}s.fire("modOperate",{id:d,cmd:"del",name:c.data("name"),ismenu:1,done:function(){if(d==8){s.fire("delSoccerTab")}}});m("del",c)});var a=false;$("#s_noadd_mods").delegate(".s-mod-item","mouseenter",function(){var b=$(this);a=true;b.addClass("is-hover");var c=($(this).find(".icon-img").attr("src")).replace(/_b.png$/,".png");$(b.find(".icon-img")[0]).attr("src",c)}).delegate(".s-mod-item","mouseleave",function(){if(!a){return}$(this).removeClass("is-hover");var b=($(this).find(".icon-img").attr("src")).replace(/.png$/,"_b.png");$($(this).find(".icon-img")[0]).attr("src",b)}).delegate(".s-mod-item","click",function(){a=false;if(!w){return}var b=$(this),c=b.data("id");s.fire("modOperate",{id:c,cmd:"add",name:b.data("name"),ismenu:1});m("add",b);if($("#s_content_99")[0]&&$("#s_content_99").height()>320){$("#s_content_99").css("position","relative")}});s.listen("superman:setting/setting_constructor","modConfirmOperate",function(b){if(b.cmd=="ok"){s.fire("modOperate",{id:b.id,cmd:"del",name:b.name,ismenu:1});n(b.id,"del",function(c){$.ajaxpost(t.submit,{cmd:"del",id:b.id,ids:c},function(d){})})}})};var n=function(e,b,a){var d=[],c=$("#s_added_mods").find(".s-mod-item");$.each(c,function(h,g){var f=$(g).data("id");if($(g).data("temp")==1||(b=="del"&&f==e)){return}d.push(f)});if(b=="add"&&$.inArray(parseInt(e,10),d)==-1){d.push(e)}};var m=function(a,b){w=false;v.updateModsLayer(a);b.hide();var c=u(a,b,b.attr("id").replace("s_moditem_","s_moveitem_"));r(a,c,b)};x.saveSeqNavs=function(a){if(!a){return}n(a,"sort",function(b){$.ajaxpost(t.submit,{cmd:"sort",id:a,ids:b},function(c){});s.fire("modOperate",{id:a,seqids:b,cmd:"drag"})})};var q=function(){var a=$("#s_added_mods").find(".s-mod-item");return a.length>0};var u=function(d,a,f){var b=a.clone();b.attr("id",f);b.data("temp",1);if(!$("#"+f)[0]){$("#s_setting_mods").append(b)}b.off("mouseover").off("mouseout").off("mouseenter").off("mouseleave");var c=$("#s_content_99").offset(),e=a.offset();b.css({position:"absolute",top:e.top-c.top-44,left:e.left-c.left,zIndex:10});return b};var r=function(d,i,c){var a="s_setting_mods",b=$("#"+a),j=$("#"+(d=="add"?"s_added_mods":"s_noadd_mods")).find(".s-mod-item").eq(-1),g=(j.index()+1)%8,l=b.offset(),e=j.offset(),z="",f="",k="",h="";if(j[0]){z=g==0?(j.offset().top+20):j.offset().top,f=g==0?(b.offset().left+30):(j.offset().left+86);k=z-l.top;h=f-l.left}else{k=d=="add"?20:($("#s_noadd_mods").offset().top-l.top+20);h=30}i.animate({top:k,left:h},{duration:100,complete:function(){i.remove();v.moveModItem(c,d);c.show();w=true}})};x.getModIds=n;x.moveModItem=m});